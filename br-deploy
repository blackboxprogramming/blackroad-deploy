#!/bin/bash
# BlackRoad Deploy CLI - Railway-like deployments for your infrastructure
# Version: 1.0.0

VERSION="1.0.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Logging functions
log_info() { echo -e "${BLUE}‚Ñπ${NC} $1"; }
log_success() { echo -e "${GREEN}‚úì${NC} $1"; }
log_warn() { echo -e "${YELLOW}‚ö†${NC} $1"; }
log_error() { echo -e "${RED}‚úó${NC} $1"; }
log_header() { echo -e "${MAGENTA}‚ñ∏${NC} ${CYAN}$1${NC}"; }

show_help() {
    cat << HELP
${CYAN}BlackRoad Deploy${NC} v${VERSION}
Railway-like deployment system for Raspberry Pis and Droplets

${YELLOW}Usage:${NC}
  br-deploy [command] [options]

${YELLOW}Commands:${NC}
  deploy <path> <target>     Deploy an application
  list <target>              List all deployed apps on target
  logs <app> <target>        Show logs for an app
  restart <app> <target>     Restart an app
  stop <app> <target>        Stop an app
  remove <app> <target>      Remove an app
  status <target>            Show target server status
  env <app> <target>         Manage environment variables
  
${YELLOW}Targets:${NC}
  aria64, aria, pi           Raspberry Pi aria64 (192.168.4.64)
  shellfish, sf, droplet     Shellfish droplet (174.138.44.45)
  alice                      Raspberry Pi alice (192.168.4.49)
  lucidia                    Raspberry Pi lucidia (192.168.4.38)

${YELLOW}Examples:${NC}
  br-deploy deploy ./my-node-app aria64
  br-deploy list shellfish
  br-deploy logs my-app aria64
  br-deploy env my-app aria64 set DATABASE_URL=postgres://...
  
${YELLOW}Supported Languages:${NC}
  ‚Ä¢ Node.js (package.json)
  ‚Ä¢ Python (requirements.txt, pyproject.toml, Pipfile)
  ‚Ä¢ Go (go.mod)
  ‚Ä¢ Rust (Cargo.toml)
  ‚Ä¢ Docker (Dockerfile)

HELP
}

# Get target host details
get_target_info() {
    local target=$1
    case "$target" in
        aria64|aria|pi)
            echo "aria64:pi"
            ;;
        shellfish|sf|droplet)
            echo "shellfish:root"
            ;;
        alice)
            echo "alice:alice"
            ;;
        lucidia)
            echo "lucidia:lucidia"
            ;;
        *)
            echo ""
            ;;
    esac
}

# Detect application type
detect_app_type() {
    local path=$1
    if [ -f "$path/package.json" ]; then
        echo "nodejs"
    elif [ -f "$path/requirements.txt" ] || [ -f "$path/pyproject.toml" ] || [ -f "$path/Pipfile" ]; then
        echo "python"
    elif [ -f "$path/go.mod" ]; then
        echo "go"
    elif [ -f "$path/Cargo.toml" ]; then
        echo "rust"
    elif [ -f "$path/Dockerfile" ]; then
        echo "docker"
    else
        echo "unknown"
    fi
}

# Deploy command
cmd_deploy() {
    local app_path="${1:-.}"
    local target="${2}"
    local app_name="${3:-$(basename $(realpath $app_path))}"
    
    if [ -z "$target" ]; then
        log_error "Target required. Usage: br-deploy deploy <path> <target> [name]"
        exit 1
    fi
    
    local target_info=$(get_target_info "$target")
    if [ -z "$target_info" ]; then
        log_error "Unknown target: $target"
        exit 1
    fi
    
    local host=$(echo $target_info | cut -d: -f1)
    local user=$(echo $target_info | cut -d: -f2)
    
    log_header "BlackRoad Deploy üöÄ"
    echo ""
    log_info "App: $app_name"
    log_info "Path: $app_path"
    log_info "Target: $host ($user)"
    echo ""
    
    cd "$app_path"
    
    # Detect app type
    local app_type=$(detect_app_type "$app_path")
    log_info "Detected: $app_type application"
    
    if [ "$app_type" == "unknown" ]; then
        log_error "Could not detect application type"
        log_info "Supported: Node.js, Python, Go, Rust, Docker"
        exit 1
    fi
    
    # Generate Dockerfile
    local dockerfile_path="$SCRIPT_DIR/dockerfiles/Dockerfile.$app_type"
    if [ "$app_type" != "docker" ]; then
        if [ -f "$dockerfile_path" ]; then
            cp "$dockerfile_path" ./Dockerfile.tmp
            log_success "Using $app_type buildpack"
        else
            log_error "No buildpack found for $app_type"
            exit 1
        fi
    fi
    
    # Build image
    local image_name="blackroad/${app_name}:latest"
    log_info "Building image: $image_name"
    
    if [ "$app_type" != "docker" ]; then
        docker build -f Dockerfile.tmp -t "$image_name" .
    else
        docker build -t "$image_name" .
    fi
    
    if [ $? -ne 0 ]; then
        log_error "Build failed"
        rm -f Dockerfile.tmp
        exit 1
    fi
    
    log_success "Build complete"
    
    # Find available port
    log_info "Allocating port on $host..."
    local port=$(ssh $user@$host "python3 -c 'import socket; s=socket.socket(); s.bind((\"\", 0)); print(s.getsockname()[1]); s.close()'")
    
    if [ -z "$port" ]; then
        log_error "Could not allocate port"
        rm -f Dockerfile.tmp
        exit 1
    fi
    
    log_success "Port allocated: $port"
    
    # Transfer image
    log_info "Transferring to $host..."
    docker save "$image_name" | ssh $user@$host "docker load"
    
    if [ $? -ne 0 ]; then
        log_error "Transfer failed"
        rm -f Dockerfile.tmp
        exit 1
    fi
    
    log_success "Transfer complete"
    
    # Deploy
    log_info "Deploying container..."
    ssh $user@$host << SSHEOF
        docker stop $app_name 2>/dev/null || true
        docker rm $app_name 2>/dev/null || true
        
        docker run -d \
            --name $app_name \
            --restart unless-stopped \
            -p $port:${PORT:-3000} \
            -e PORT=${PORT:-3000} \
            $image_name
SSHEOF
    
    if [ $? -ne 0 ]; then
        log_error "Deployment failed"
        rm -f Dockerfile.tmp
        exit 1
    fi
    
    # Get host IP
    local host_ip=$(ssh $user@$host 'hostname -I | awk "{print \$1}"')
    
    # Cleanup
    rm -f Dockerfile.tmp
    
    # Success message
    echo ""
    log_success "Deployment successful! üéâ"
    echo ""
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo -e "  ${CYAN}App:${NC}     $app_name"
    echo -e "  ${CYAN}Host:${NC}    $host"
    echo -e "  ${CYAN}Port:${NC}    $port"
    echo -e "  ${CYAN}URL:${NC}     http://$host_ip:$port"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
    log_info "View logs: br-deploy logs $app_name $target"
}

# List deployed apps
cmd_list() {
    local target="${1}"
    
    if [ -z "$target" ]; then
        log_error "Target required. Usage: br-deploy list <target>"
        exit 1
    fi
    
    local target_info=$(get_target_info "$target")
    local host=$(echo $target_info | cut -d: -f1)
    local user=$(echo $target_info | cut -d: -f2)
    
    log_header "Deployed apps on $host"
    echo ""
    
    ssh $user@$host "docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'"
}

# Show logs
cmd_logs() {
    local app="${1}"
    local target="${2}"
    
    if [ -z "$app" ] || [ -z "$target" ]; then
        log_error "Usage: br-deploy logs <app> <target>"
        exit 1
    fi
    
    local target_info=$(get_target_info "$target")
    local host=$(echo $target_info | cut -d: -f1)
    local user=$(echo $target_info | cut -d: -f2)
    
    log_info "Showing logs for $app on $host (Ctrl+C to exit)"
    echo ""
    
    ssh $user@$host "docker logs -f $app"
}

# Restart app
cmd_restart() {
    local app="${1}"
    local target="${2}"
    
    if [ -z "$app" ] || [ -z "$target" ]; then
        log_error "Usage: br-deploy restart <app> <target>"
        exit 1
    fi
    
    local target_info=$(get_target_info "$target")
    local host=$(echo $target_info | cut -d: -f1)
    local user=$(echo $target_info | cut -d: -f2)
    
    log_info "Restarting $app on $host..."
    ssh $user@$host "docker restart $app"
    
    if [ $? -eq 0 ]; then
        log_success "Restarted successfully"
    else
        log_error "Restart failed"
        exit 1
    fi
}

# Stop app
cmd_stop() {
    local app="${1}"
    local target="${2}"
    
    if [ -z "$app" ] || [ -z "$target" ]; then
        log_error "Usage: br-deploy stop <app> <target>"
        exit 1
    fi
    
    local target_info=$(get_target_info "$target")
    local host=$(echo $target_info | cut -d: -f1)
    local user=$(echo $target_info | cut -d: -f2)
    
    log_info "Stopping $app on $host..."
    ssh $user@$host "docker stop $app"
    
    if [ $? -eq 0 ]; then
        log_success "Stopped successfully"
    else
        log_error "Stop failed"
        exit 1
    fi
}

# Remove app
cmd_remove() {
    local app="${1}"
    local target="${2}"
    
    if [ -z "$app" ] || [ -z "$target" ]; then
        log_error "Usage: br-deploy remove <app> <target>"
        exit 1
    fi
    
    local target_info=$(get_target_info "$target")
    local host=$(echo $target_info | cut -d: -f1)
    local user=$(echo $target_info | cut -d: -f2)
    
    log_warn "This will permanently remove $app from $host"
    read -p "Continue? (y/N): " confirm
    
    if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
        log_info "Cancelled"
        exit 0
    fi
    
    log_info "Removing $app from $host..."
    ssh $user@$host "docker stop $app && docker rm $app"
    
    if [ $? -eq 0 ]; then
        log_success "Removed successfully"
    else
        log_error "Remove failed"
        exit 1
    fi
}

# Show status
cmd_status() {
    local target="${1}"
    
    if [ -z "$target" ]; then
        log_error "Target required. Usage: br-deploy status <target>"
        exit 1
    fi
    
    local target_info=$(get_target_info "$target")
    local host=$(echo $target_info | cut -d: -f1)
    local user=$(echo $target_info | cut -d: -f2)
    
    log_header "Status: $host"
    echo ""
    
    ssh $user@$host << 'SSHEOF'
echo "=== System ==="
uptime
echo ""
echo "=== Disk ==="
df -h / | grep -E 'Filesystem|/$'
echo ""
echo "=== Memory ==="
free -h
echo ""
echo "=== Containers ==="
docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}' | head -10
SSHEOF
}

# Main command router
main() {
    local command="${1}"
    
    case "$command" in
        deploy)
            shift
            cmd_deploy "$@"
            ;;
        list|ls)
            shift
            cmd_list "$@"
            ;;
        logs)
            shift
            cmd_logs "$@"
            ;;
        restart)
            shift
            cmd_restart "$@"
            ;;
        stop)
            shift
            cmd_stop "$@"
            ;;
        remove|rm)
            shift
            cmd_remove "$@"
            ;;
        status)
            shift
            cmd_status "$@"
            ;;
        --version|-v)
            echo "BlackRoad Deploy v${VERSION}"
            ;;
        --help|-h|help|"")
            show_help
            ;;
        *)
            log_error "Unknown command: $command"
            echo "Run 'br-deploy --help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
